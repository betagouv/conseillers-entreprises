- meta title: t('.title')

= render partial: 'steps', locals: { current_page_step: 4, diagnosis_step: @diagnosis.step }

#step4-app
  - if @diagnosis.needs.empty?
    %p= t('.no_needs')
  - else
    %p= t('.explanation')

    = form_for :matches, url: selection_diagnosis_path, method: :post,
               html: { id: 'step4-form' }, data: { confirm: '' } do |f|
      - @diagnosis.needs.ordered_for_interview.each do |need|
        %table.ui.compact.small.table.celled
          %thead
            %tr
              %th{ colspan: 3 }= need.subject
          %tbody
            - experts_skills = ExpertSkill.relevant_for(need)
            - support_skills = ExpertSkill.support_for(@diagnosis)
            - if experts_skills.present?
              = render partial: 'expert_skill_checkboxes', locals: { f: f, need: need, experts_skills: experts_skills }
            - elsif support_skills.present?
              %tr
              %td{ colspan: 3 }
                .ui.warning.message
                  = t('.no_expert_skill')
                  = t('.you_can_contact_support')
              = render partial: 'expert_skill_checkboxes', locals: { f: f, need: need, experts_skills: support_skills }
            - else
              %tr
                %td= t('.no_expert_skill')

      .ui.info.message
        = t('.before_sending_emails_text_html')

      .ui.two.column.stackable.grid.container
        .ui.left.aligned.column.no-left-padding.no-margin
          = link_to visite_diagnosis_path(@diagnosis), class: 'ui left labeled icon button no-margin' do
            = t('previous_step')
            %i.arrow.left.icon

        .ui.right.aligned.column.no-right-padding.no-margin
          - button_classes = []
          - if @diagnosis.visitee.blank?
            - button_classes << 'disabled'
          %button.ui.green.button.no-margin#next-step-button{ class: button_classes }
            = t('.notify_matches')

      .clear

:javascript
  (function() {
    var checkboxes = $("#step4-form input:checkbox");
    function setBoxesValidity() {
      if (checkboxes.is(":checked")) {
        checkboxes.each(function() {
          this.setCustomValidity("");
        });
      } else {
        checkboxes.each(function() {
          this.setCustomValidity("#{ t('.select_at_least_one_expert') }");
        });
      }
    }
    checkboxes.on("click", function() {
      setBoxesValidity();
    });
    $(document).ready(function(){
      setBoxesValidity();
    });
  }) ()
